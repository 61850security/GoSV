#include <arpa/inet.h> 
#include <linux/if_packet.h> 
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/socket.h>
#include <net/if.h>
#include <netinet/ether.h>
#include <unistd.h>

// Broadcast mac address
#define DEST_MAC0    0xFF
#define DEST_MAC1    0xFF
#define DEST_MAC2    0xFF
#define DEST_MAC3    0xFF
#define DEST_MAC4    0xFF
#define DEST_MAC5    0xFF



// Enter your network adapter MAC address in hexadecimal values  
#define DEST_MAC0    0xXX
#define DEST_MAC1    0xXX
#define DEST_MAC2    0xXX
#define DEST_MAC3    0xXX
#define DEST_MAC4    0xXX
#define DEST_MAC5    0xXX



#define DEFAULT_IF  "Enter the name of your network adapter"
#define BUF_SIZ     2048 

/* Enter your custom values in hexa decimal    */

char a[64][10]= { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x0A, 0x14, 0x1E, 0x28, 0x32, 0x3C, 0x46, 0x50, 0x5A,
                  0x00, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 
                  0x00, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15,
                  0x00, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x0A, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
                  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 
                  0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 
                  0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17,
                  0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 
		  0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
                  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
                  0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
                  0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 
                  0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
                  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 
                  0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 
                  0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17,
                  0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 
		  0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
                  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
                  0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
                  0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 
                  0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
                  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 
                  0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 
                  0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17,
                  0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 
		  0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
                  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
                  0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
                  0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 
                  0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
                  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 
                  0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 
                  0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
                  0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
                  0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17,
                  0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16 };



/* SV PDU tag length value fields */ 
/* Enter your custome values in length and values */

char APPID_1 =0x40;                  /* Application identifier */
char APPID_2 =0x00; 
char length_1 =0x00;                 /* length  */
char length_2=0x6e;
char resrv1_1=0x00; 		     /* reservation1 - security related fields  */
char resrv1_2=0x00;                   
char resrv2_1=0x00;		     /* reservation2 - security related fields */
char resrv2_2=0x00;                  
char sav_PDU_tag=0x60;               /* sav_PDU tag  */
char sav_PDU_length=0x64; 	     /* sav_PDU length - size of APDU */
char noASDU_tag=0x80;		     /* number of ASDU tag  */ 
char noASDU_length=0x01;             /* number of ASDU length */
char noASDU=0x01;                    /* noASDU value  */
char SequenceofASDU_tag=0xA2;        /* SequenceofASDU tag   */
char SequenceofASDU_length=0x5F;     /* SequenceofASDU length - size of all ASDU  */
char ASDU_tag=0x30;                  /* ASDU tag */
char ASDU_length=0x5D;               /* ASDU length */
char svID_tag =0x80;                 /* Sample Value identifier tag   */
char svID_length =0x0C;              /* Sample Value identifier length */
char svID_1=0x46;                    /*  svID[12] naming   */
char svID_2=0x52;
char svID_3=0x45;
char svID_4=0x41;
char svID_5=0x2D;
char svID_6=0x47;
char svID_7=0x6F;
char svID_8=0x53;
char svID_9=0x56;
char svID_10=0x2D;  
char svID_11=0x31;
char svID_12=0x38;
char smpCnt_tag=0x82;                /* sample count tag */
char smpCnt_length =0x02;            /* sample count length */
char smpCnt_1=0x00;                  /* sample count */
char confRev_tag=0x83;               /* confRev tag - configuratin revision number */
char confRev_length=0x04;            /* confRev length */
char confRev1=0x00;                  /* confRev value */
char confRev2=0x00; 	     
char confRev3=0x00;
char confRev4=0x01;                   
char smpSynch_tag = 0x85;            /* smpSynch tag -synchronization identifier */
char smpSynch_length =0x01;          /* smpSynch_length */
char smpSynch =0x00; 		     /* smpSynch value  */
char SequenceofData_tag =0x87;       /* SequenceofData tag */
char SequenceofData_length=0x40;     /* SequenceofData length */
// sample count values
char smp[15] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F};

int main(int argc, char *argv[])
{
    int sockfd, i=0, j, k, q=0, buf_len;
    char sendbuf[BUF_SIZ];
    char ifName[IFNAMSIZ];
    struct ifreq if_idx, if_mac;
    struct sockaddr_ll socket_address; /* The sockaddr_ll structure is a device-independent physical-layer address.*/
 

    /* Get interface name */
    if (argc > 1)
        strcpy(ifName, argv[1]);
    else
        strcpy(ifName, DEFAULT_IF);

    /* Open RAW socket to send on */
    if ((sockfd = socket(AF_PACKET, SOCK_RAW, IPPROTO_RAW)) == -1) 
        perror("socket");
   
    /* Initializing the ifreq structure to zero */
    memset(&if_idx, 0, sizeof(struct ifreq));

    /* copying the interface name into ifName string */  
    strncpy(if_idx.ifr_name, ifName, IFNAMSIZ-1);

    /* Retrieve the interface number using ioctl SIOCGIFINDEX */
    if (ioctl(sockfd, SIOCGIFINDEX, &if_idx) < 0)
        perror("SIOCGIFINDEX");
   
    // Loop forever generating SV packet with custom values
    while(1) {

        /* Buffer of BUF_SIZ bytes we'll construct our frame in.
           First, clear it all to zero. */
        memset(sendbuf, 0, BUF_SIZ);
        buf_len = 0;

        /* Construct the Ethernet header */

        /* Destination address */
        sendbuf[buf_len++] = DEST_MAC0;
        sendbuf[buf_len++] = DEST_MAC1;
        sendbuf[buf_len++] = DEST_MAC2;
        sendbuf[buf_len++] = DEST_MAC3;
        sendbuf[buf_len++] = DEST_MAC4;
        sendbuf[buf_len++] = DEST_MAC5;
	

        /* Source address */
        sendbuf[buf_len++] = ((uint8_t *)&if_mac.ifr_hwaddr.sa_data)[0];
        sendbuf[buf_len++] = ((uint8_t *)&if_mac.ifr_hwaddr.sa_data)[1];
        sendbuf[buf_len++] = ((uint8_t *)&if_mac.ifr_hwaddr.sa_data)[2];
        sendbuf[buf_len++] = ((uint8_t *)&if_mac.ifr_hwaddr.sa_data)[3];
        sendbuf[buf_len++] = ((uint8_t *)&if_mac.ifr_hwaddr.sa_data)[4];
        sendbuf[buf_len++] = ((uint8_t *)&if_mac.ifr_hwaddr.sa_data)[5];

	/* VLAN values */
        sendbuf[buf_len++] = 0x81;
        sendbuf[buf_len++] = 0x00;
        sendbuf[buf_len++] = 0x80;
        sendbuf[buf_len++] = 0x00;

        /* Ethertype field */
        sendbuf[buf_len++] = 0x88;
        sendbuf[buf_len++] = 0xBA;


        /*  PDU fields */
        sendbuf[buf_len++] = APPID_1;
        sendbuf[buf_len++] = APPID_2;
        sendbuf[buf_len++] = length_1;
        sendbuf[buf_len++] = length_2;
        sendbuf[buf_len++] = resrv1_1;
	sendbuf[buf_len++] = resrv1_2; 
        sendbuf[buf_len++] = resrv2_1;
        sendbuf[buf_len++] = resrv2_2;
     

        /* APDU fields */
        sendbuf[buf_len++] = sav_PDU_tag;
        sendbuf[buf_len++] = sav_PDU_length;
	sendbuf[buf_len++] = noASDU_tag;
	sendbuf[buf_len++] = noASDU_length;
	sendbuf[buf_len++] = noASDU;
	sendbuf[buf_len++] = SequenceofASDU_tag;
	sendbuf[buf_len++] = SequenceofASDU_length;

	/* ASDU fields */
	sendbuf[buf_len++] = ASDU_tag;
	sendbuf[buf_len++] = ASDU_length;
	sendbuf[buf_len++] = svID_tag;        
        sendbuf[buf_len++] = svID_length;
        sendbuf[buf_len++] = svID_1;
        sendbuf[buf_len++] = svID_2;
	sendbuf[buf_len++] = svID_3;
	sendbuf[buf_len++] = svID_4;
	sendbuf[buf_len++] = svID_5;
	sendbuf[buf_len++] = svID_6;
	sendbuf[buf_len++] = svID_7;
	sendbuf[buf_len++] = svID_8;
	sendbuf[buf_len++] = svID_9;
	sendbuf[buf_len++] = svID_10;
	sendbuf[buf_len++] = svID_11;
	sendbuf[buf_len++] = svID_12;
	sendbuf[buf_len++] = smpCnt_tag;
	sendbuf[buf_len++] = smpCnt_length;
	sendbuf[buf_len++] = smpCnt_1;

	sendbuf[buf_len++] = smp[q];	

	q++;
	if (q==10)
	    q = 0;

        sendbuf[buf_len++] = confRev_tag;	
	sendbuf[buf_len++] = confRev_length;
	sendbuf[buf_len++] = confRev1;
        sendbuf[buf_len++] = confRev2;
	sendbuf[buf_len++] = confRev3;
	sendbuf[buf_len++] = confRev4;
	sendbuf[buf_len++] = smpSynch_tag;
	sendbuf[buf_len++] = smpSynch_length;
        sendbuf[buf_len++] = smpSynch;	
        sendbuf[buf_len++] = SequenceofData_tag;
	sendbuf[buf_len++] = SequenceofData_length;
        
        /* ASDU data */
        for(j=0;j<=63;j++)
           sendbuf[buf_len++]= a[j][i];
       
        i++;
        if ( i == 10)
           i=0;

        /* copy the Index of the network device */
        socket_address.sll_ifindex = if_idx.ifr_ifindex;  

        /* Length of Ethernet address */
        socket_address.sll_halen = ETH_ALEN;

        /* Destination MAC */
        socket_address.sll_addr[0] = DEST_MAC0;
        socket_address.sll_addr[1] = DEST_MAC1;
        socket_address.sll_addr[2] = DEST_MAC2;
        socket_address.sll_addr[3] = DEST_MAC3;
        socket_address.sll_addr[4] = DEST_MAC4;
        socket_address.sll_addr[5] = DEST_MAC5;

        /* Send packet using sendto function */
        if (sendto(sockfd, sendbuf, buf_len, 0, (struct sockaddr*)&socket_address, sizeof(struct sockaddr_ll)) < 0)
            printf("Send failed\n");
        else {
            printf("Sent :");
            for (k=0; k < buf_len; k++)
                printf("%02x:", sendbuf[k]);
            printf("\n");
        }
        /* Wait for one second 1 second */

        usleep(1000000);
    }
    return 0;
}

